#!/usr/bin/bash

prefix1='<<BUILD OSTAP>>'
prefix1_error='<<BUILD OSTAP *ERROR*>>'
prefix2=${prefix1}
prefix2_error=${prefix1_error}

COLORS=$(tput colors 2> /dev/null)
if [[ $? == 0  && $COLORS -gt 2 ]]
then
    FWHITE='\033[1;97m'     # White
    BGREEN='\033[42m'       # Green
    FYELLOW='\033[1;93m'    # Yellow
    BRED='\033[6;101m'      # Red
    ##
    COLOR_OK=${FYELLOW}${BGREEN}
    COLOR_ERR=${FYELLOW}${BRED}
    COLOR_OFF='\033[0m' 
    ##
    prefix=${COLOR_OK}${prefix}${COLOR_OFF}
    prefix_error=${COLOR_ERR}${prefix_error}${COLOR_OFF}
    prefix1=${COLOR_OK}${prefix1}${COLOR_OFF}
    prefix1_error=${COLOR_ERR}${prefix1_error}${COLOR_OFF}
    prefix2=${COLOR_OK}${prefix2}${COLOR_OFF}
    prefix2_error=${COLOR_ERR}${prefix2_error}${COLOR_OFF}
    ## 
fi

OSTAP_SOURCE=${1:-${OSTAP_SOURCE}}
OSTAP_BUILD=${2:-${OSTAP_BUILD}}
OSTAP_INSTALL=${3:-${OSTAP_INSTALL}}

if [[   ${ROOTSYS} &&
     -d ${ROOTSYS} ]]
then 
    true
else 
    echo -e ${prefix1_error}' No ROOTSYS directory:' ${ROOTSYS}
    return 200
fi

if [[    ${OSTAP_SOURCE}                && 
      -d ${OSTAP_SOURCE}                &&
      -d ${OSTAP_SOURCE}/cmake          &&
      -d ${OSTAP_SOURCE}/data           &&
      -d ${OSTAP_SOURCE}/docs           &&
      -d ${OSTAP_SOURCE}/examples       &&
      -d ${OSTAP_SOURCE}/ostap          &&
      -d ${OSTAP_SOURCE}/scripts        &&
      -d ${OSTAP_SOURCE}/source         &&
      -d ${OSTAP_SOURCE}/ReleaseNotes   &&
      -f ${OSTAP_SOURCE}/CMakeLists.txt ]]
then
    true 
else 	
    echo -e ${prefix1_error}' No valid source directory is found! '${OSTAP_SOURCE}
    return 201
fi

if   [[    ${OSTAP_BUILD} &&
	-d ${OSTAP_BUILD} &&
	-w ${OSTAP_BUILD} ]]
then
    true 
elif [[ -w ${OSTAP_SOURCE} ]]
then 
    mkdir ${OSTAP_SOURCE}/build
    OSTAP_BUILD=${OSTAP_SOURCE}/build  
    echo -e ${prefix1}' Build directory is created:' ${OSTAP_BUILD}
else
    OSTAP_BUILD=`mktemp -d -t ostap-$(date '+%Y-%b-%d')-OSTAP-BUILD-DIR-XXXXXX`
    echo -e ${prefix1}' Build directory is created:' ${OSTAP_BUILD}
fi 

if [[ -f rebuild_ostap.sh ]]
then
    rm -f rebuild_ostap.sh
fi

if [[ -f ${OSTAP_BUILD}/.rebuild-ostap ]]
then
    rm -f ${OSTAP_BUILD}/.rebuild-ostap 
fi


cat <<EOF >rebuild_ostap.sh
#!/usr/bin/bash 




if [[  ${ROOTSYS} &&
    -d ${ROOTSYS} ]]
then 
    echo -e "${prefix2}"' Use ROOTSYS       = '${ROOTSYS} 
else 
    echo -e "${prefix2_error}"' No ROOTSYS directory: '${ROOTSYS}
    return 202
fi

if [[ -d ${OSTAP_SOURCE} ]]
then 
    echo -e "${prefix2}"' Use OSTAP_SOURCE  = '${OSTAP_SOURCE}
else
    echo -e "${prefix2_error}"' No valid source directory is found!' ${OSTAP_SOURCE}
    return 203 
fi

if [[ -d ${OSTAP_BUILD} && -w ${OSTAP_BUILD} ]]
then
    echo -e "${prefix2}"' Use OSTAP_BUILD   = '${OSTAP_BUILD} 
else
    echo -e "${prefix2_error}"' No valid build directory is found!' ${OSTAP_BUILD}
    return 204 
fi 

echo -e "${prefix2}"' Use OSTAP_INSTALL = '${OSTAP_INSTALL}

if [[ -f ${OSTAP_BUILD}/build.ninja ]]
then
    ( echo -e "${prefix2}"' [1/7] Clean  OSTAP_BUILD   build remnants   '${OSTAP_BUILD} ; cd ${OSTAP_BUILD} ; ninja clean )
fi

( echo -e "${prefix2}"' [2/7] Remove OSTAP_BUILD   remnants&garbage '${OSTAP_BUILD}  ;
  cd ${OSTAP_BUILD} ;
  rm -rf CM* CP* CT* *nin* scripts/ source/ ostap/ examples/ Testing/ Ma* .nin* Dart* cmake* instal* packages Tes* *.py~ *.C~ __* _CPack* \#* *~ .*~ .\#* )

if [[ -d ${OSTAP_INSTALL} && -w ${OSTAP_INSTALL} ]]
then
    ( echo -e "${prefix2}"' [3/7] Clean  OSTAP_INSTALL directory        '${OSTAP_INSTALL} ;
      cd ${OSTAP_INSTALL} ;
      rm -rf .footprints .ostap.build .ostaprc .rootlogon.C cmake examples include lib scripts thisostap.sh packages )
fi

( echo -e "${prefix2}"' [4/7] First  pass of cmake&ninja&install    '${OSTAP_BUILD} ;
  cd ${OSTAP_BUILD} ;
  cmake --fresh ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date | grep -v Installing )

if [[ -d ${OSTAP_INSTALL} ]]
then
    true
else 
    echo -e "${prefix2_error}"' Missing install directory! '${OSTAP_INSTALL}
    return 205 
fi 

( echo -e "${prefix2}"' [5/7] Second pass of cmake&ninja&install'    ${OSTAP_BUILD} ;
  cd ${OSTAP_BUILD} ;
  cmake         ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date | grep -v Installing )

if [[ -f ${OSTAP_INSTALL}/thisostap.sh &&
      -x ${OSTAP_INSTALL}/thisostap.sh ]]
then
    source ${OSTAP_INSTALL}/thisostap.sh
else
    echo -e "${prefi2_error}"' No thisostap.sh is found ' ${OSTAP_INSTALL}/thisostap.sh 
    return 206
fi

( echo -e "${prefix2}"' [6/7] Third  pass of cmake&ninja&install    '${OSTAP_BUILD} ;
  cd ${OSTAP_BUILD} ;
  cmake         ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date | grep -v Installing )

## ( echo -e "${prefix2}"' [7/7] Last   pass of cmake&ninja&package'  ;
##   cd ${OSTAP_BUILD} ;
##   cmake         ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja package  )

echo -e "${prefix2}"' ROOTSYS         : '${ROOTSYS}
echo -e "${prefix2}"' OSTAPDIR        : '${OSTAPDIR}
echo -e "${prefix2}"' OSTAP_SOURCE    : '${OSTAP_SOURCE}
echo -e "${prefix2}"' OSTAP_BUILD     : '${OSTAP_BUILD}
echo -e "${prefix2}"' OSTAP_INSTALL   : '${OSTAP_INSTALL}
echo -e "${prefix2}"' thisostap.sh    : '${OSTAP_INSTALL}/thisostap.sh
echo -e "${prefix2}"' root            : '\$(which root       )
echo -e "${prefix2}"' root.exe        : '\$(which root.exe   )
echo -e "${prefix2}"' root version    : '\$(root.exe --version 2>&1 | sed -E "s/\\\\n/ /g" )
echo -e "${prefix2}"' python          : '\$(which python    )
echo -e "${prefix2}"' root version    : '\$(python   -VV       2>&1 | sed -E "s/\\\\n/ /g" )
echo -e "${prefix2}"' ostap           : '\$(which ostap     )
echo -e "${prefix2}"' root version    : '\$(ostap    --version 2>&1 | sed -E "s/\\\\n/ /g" )

if command -v tree &> /dev/null
then
    tree -d -L 3 --charset UTF-8 ${OSTAP_INSTALL}
fi 

EOF

if [[ -f ./rebuild_ostap.sh ]]
then
    mv ./rebuild_ostap.sh ${OSTAP_BUILD}/.rebuild-ostap
    chmod 755 ${OSTAP_BUILD}/.rebuild-ostap
else
    echo -e "${prefix2_error}"' No .rebuild-ostap is found '${OSTAP_BUIILD}/.rebuild-ostap
    return 207 
fi

echo -e ${prefix1}' Source .rebuild-ostap ' ${OSTAP_BUILD}/.rebuild-ostap
## cat ${OSTAP_BUILD}/.rebuild-ostap
source ${OSTAP_BUILD}/.rebuild-ostap
result=$?


return ${result}
