#!/usr/bin/bash

OSTAP_SOURCE=${1}

if [[ $ROOTSYS && -d $ROOTSYS ]]
then 
  true  
else 
  echo 'BUILD OSTAP    : No ROOTSYS directory:' $ROOTSYS 
  return 100
fi

if [[ $OSTAP_SOURCE                &&
      -d $OSTAP_SOURCE             &&
      -d $OSTAP_SOURCE/ostap       &&
      -d $OSTAP_SOURCE/source      &&
      -d $OSTAP_SOURCE/scripts     &&
      -d $OSTAP_SOURCE/examples    &&
      -d $OSTAP_SOURCE/data        &&
      -f $OSTAP_SOURCE/CMakeLists.txt ]]
then  	 
  true
else 	
  echo 'BUILD OSTAP       : No valid source directory is found!' $OSTAP_SOURCE 
  return 200 
fi

OSTAP_BUILD=${2:-$OSTAP_SOURCE/build}

if [[ $OSTAP_BUILD && -d $OSTAP_BUILD && -w $OSTAP_BUILD ]]
then
    true
elif [[ -w $OSTAP_SOURCE ]]
then 
    mkdir $OSTAP_SOURCE/build
    OSTAP_BUILD=$OSTAP_SOURCE/build  
    echo  'BUILD OSTAP       : Build directory is created' $OSTAP_BUILD
else
    OSTAP_BUILD=`mktemp -d -t ostap-$(date '+%Y-%b-%d')-OSTAP-BUILD-DIR-XXXXXX`
    echo  'BUILD OSTAP       : Build directory is created' $OSTAP_BUILD
fi 

OSTAP_INSTALL=${3:-$OSTAP_BUILD/INSTALL}

if [[ -f $OSTAP_BUILD/build.ninja ]]
then
( echo 'BUILD OSTAP [1/7] : CLEAN BUILD REMNANTS'       ; cd $OSTAP_BUILD   ; echo ' - BUILD OSTAP    : CWD ' $PWD ; ninja clean )
fi

if [[ $OSTAP_INSTALL && -d $OSTAP_INSTALL ]]
then
( echo 'BUILD OSTAP [2/7] : CLEAN INSTALL DIRECTORY'    ; cd $OSTAP_INSTALL ; echo ' - BUILD OSTAP    : CWD ' $PWD ; rm -rfv .footprints .ostap.build .ostaprc .rootlogon.C cmake examples include lib scripts .rebuild-ostap rebuild_ostap.sh thisostap.sh packages )
fi

( echo 'BUILD OSTAP [3/7] : REMOVE REMNANTS & GARBAGE'  ; cd $OSTAP_BUILD   ; echo ' - BUILD OSTAP    : CWD ' $PWD ; rm -rfv CM* CP* CT* *nin* scripts/ source/ ostap/ examples/ Testing/ Ma* .nin* Dart* cmake* instal* packages Tes* *.py~ *.C~ __* _CPack* \#* *~ .*~ .\#* )
( echo 'BUILD OSTAP [4/7] : FIRST  PASS OF CMAKE+NINJA' ; cd $OSTAP_BUILD   ; echo ' - BUILD OSTAP    : CWD ' $PWD ; cmake --fresh $OSTAP_SOURCE -DCMAKE_INSTALL_PREFIX=$OSTAP_INSTALL -G Ninja ; ninja ; ninja install | grep -v Up-to-date )
( echo 'BUILD OSTAP [5/7] : SECOND PASS OF CMAKE+NINJA' ; cd $OSTAP_BUILD   ; echo ' - BUILD OSTAP    : CWD ' $PWD ; cmake         $OSTAP_SOURCE -DCMAKE_INSTALL_PREFIX=$OSTAP_INSTALL -G Ninja ; ninja ; ninja install | grep -v Up-to-date )

if [[ -f $OSTAP_INSTALL/thisostap.sh &&
      -x $OSTAP_INSTALL/thisostap.sh ]]
then
  source $OSTAP_INSTALL/thisostap.sh
else
  echo 'BUILD OSTAP       : No thisostap.sh is found ' $OSTAP_INSTALL/thisostap.sh 
  return 300 
fi
(  echo 'BUILD OSTAP [6/7] : THIRD  PASS OF CMAKE+NINJA'   ; cd $OSTAP_BUILD ; echo ' - BUILD OSTAP    : CWD ' $PWD ; cmake $OSTAP_SOURCE -DCMAKE_INSTALL_PREFIX=$OSTAP_INSTALL -G Ninja ; ninja ; ninja install | grep -v Up-to-date )
(  echo 'BUILD OSTAP [7/7] : LAST   PASS OF NINJA+PACKAGE' ; cd $OSTAP_BUILD ; echo ' - BUILD OSTAP    : CWD ' $PWD ; ninja ; ninja install | grep -v Up-to-date ; ninja package )

if [[ -d $OSTAP_BUILD/_CPack_Packages ]]
then
    rm -rf $OSTAP_BUILD/_CPack_Packages
fi


cat <<EOF >rebuild_ostap.sh
#!/usr/bin/bash 

echo 'REBUILD OSTAP  OSTAP_SOURCE  : ' ${OSTAP_SOURCE} 
echo 'REBUILD OSTAP  OSTAP_BUILD   : ' ${OSTAP_BUILD} 
echo 'REBUILD OSTAP  OSTAP_INSTALL : ' ${OSTAP_INSTALL} 

( echo 'REBUILD OSTAP [1/8] : NO CEANUP' ;  )
( echo 'REBUILD OSTAP [2/8] : NO CEANUP' ;  )

## if [[ -d ${OSTAP_BUILD} && -f ${OSTAP_BUILD}/build.ninja ]]
## then
## ( echo 'REBUILD OSTAP [1/8] : CLEAN BUILD REMNANTS'       ; cd ${OSTAP_BUILD}   ; echo ' - REBUILD OSTAP    : CWD ' $PWD ; ninja clean )
## fi

## if [[ ${OSTAP_INSTALL} && -d ${OSTAP_INSTALL} ]]
## then
## ( echo 'REBUILD OSTAP [2/8] : CLEAN INSTALL DIRECTORY'    ; cd ${OSTAP_INSTALL} ; echo ' - REBUILD OSTAP    : CWD ' $PWD ; rm -rfv .footprints .ostap.build .ostaprc .rootlogon.C cmake examples include lib scripts thisostap.sh packages )
## fi

( echo 'REBUILD OSTAP [3/8] : REMOVE REMNANTS & GARBAGE'  ; cd ${OSTAP_BUILD}   ; echo ' - REBUILD OSTAP    : CWD ' $PWD ; rm -rfv CM* CP* CT* *nin* scripts/ source/ ostap/ examples/ Testing/ Ma* .nin* Dart* cmake* instal* packages Tes* *.py~ *.C~ __* _CPack* \#* *~ .*~ .\#* )
( echo 'REBUILD OSTAP [4/8] : FIRST  PASS OF CMAKE+NINJA' ; cd ${OSTAP_BUILD}   ; echo ' - REBUILD OSTAP    : CWD ' $PWD ; cmake --fresh ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date )
( echo 'REBUILD OSTAP [5/8] : SECOND PASS OF CMAKE+NINJA' ; cd ${OSTAP_BUILD}   ; echo ' - REBUILD OSTAP    : CWD ' $PWD ; cmake         ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date )

if [[ -f ${OSTAP_INSTALL}/thisostap.sh &&
      -x ${OSTAP_INSTALL}/thisostap.sh ]]
then
  source ${OSTAP_INSTALL}/thisostap.sh
else
  echo 'REBUILD OSTAP       : No thisostap.sh is found ' ${OSTAP_INSTALL}/thisostap.sh 
  return 300 
fi

( echo 'REBUILD OSTAP [6/8] : THIRD  PASS OF CMAKE+NINJA'   ; cd ${OSTAP_BUILD} ; echo ' - REBUILD OSTAP    : CWD ' $PWD ; cmake ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date )
( echo 'REBUILD OSTAP [7/8] : LAST   PASS OF NINJA'         ; cd ${OSTAP_BUILD} ; echo ' - REBUILD OSTAP    : CWD ' $PWD ; ninja ; ninja install | grep -v Up-to-date )

( echo 'REBUILD OSTAP [8/7] : NO CPACK' ;  )

echo 'REBUILD OSTAP     : ROOTSYS         : ' ${ROOTSYS}
echo 'REBUILD OSTAP     : OSTAPDIR        : ' ${OSTAPDIR}
echo 'REBUILD OSTAP     : OSTAP_SOURCE    : ' ${OSTAP_SOURCE}
echo 'REBUILD OSTAP     : OSTAP_BUILD     : ' ${OSTAP_BUILD}
echo 'REBUILD OSTAP     : python          : ' `which python`
echo 'REBUILD OSTAP     : root.exe        : ' `which root.exe`
echo 'REBUILD OSTAP     : ostap           : ' `which ostap`
echo 'REBUILD OSTAP     : PYTHON VERSION  : ' `python --version`
echo 'REBUILD OSTAP     : OSTAP  VERSION  : ' `ostap  --version`
echo 'REBUILD OSTAP     : OSTAP_INSTALL   : ' ${OSTAP_INSTALL}

if command -v tree &> /dev/null
then
    tree -d -L 3 --charset UTF-8 ${OSTAP_INSTALL}
fi 

EOF

if [[ -f ./rebuild_ostap.sh ]]
then
    mv ./rebuild_ostap.sh $OSTAP_BUILD/.rebuild-ostap
    chmod 755 $OSTAP_BUILD/.rebuild-ostap
fi

echo 'BUILD OSTAP       : ROOTSYS         : ' $ROOTSYS
echo 'BUILD OSTAP       : OSTAPDIR        : ' $OSTAPDIR
echo 'BUILD OSTAP       : OSTAP_SOURCE    : ' $OSTAP_SOURCE
echo 'BUILD OSTAP       : OSTAP_BUILD     : ' $OSTAP_BUILD
echo 'BUILD OSTAP       : python          : ' `which python`
echo 'BUILD OSTAP       : root.exe        : ' `which root.exe`
echo 'BUILD OSTAP       : ostap           : ' `which ostap`
echo 'BUILD OSTAP       : PYTHON VERSION  : ' `python --version`
echo 'BUILD OSTAP       : OSTAP  VERSION  : ' `ostap  --version`
echo 'BUILD OSTAP       : OSTAP_INSTALL   : ' $OSTAP_INSTALL

if command -v tree &> /dev/null
then
    tree -d -L 3 --charset UTF-8 $OSTAP_INSTALL
fi 
