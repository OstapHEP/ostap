#!/usr/bin/bash

OSTAP_SOURCE=${1}

if [[ -d ${ROOTSYS} ]]
then 
    echo '----> BUILD OSTAP : ROOTSYS='${ROOTSYS} 
else 
    echo ' ERROR BUILD OSTAP : No ROOTSYS directory:' ${ROOTSYS}
    return 100
fi

if [[ -d ${OSTAP_SOURCE}             &&
      -d ${OSTAP_SOURCE}/ostap       &&
      -d ${OSTAP_SOURCE}/source      &&
      -d ${OSTAP_SOURCE}/scripts     &&
      -d ${OSTAP_SOURCE}/examples    &&
      -d ${OSTAP_SOURCE}/data        &&
      -f ${OSTAP_SOURCE}/CMakeLists.txt ]]
then  	 
    echo '----> BUILD OSTAP : OSTAP_SOURCE='${OSTAP_SOURCE}
else 	
    echo ' ERROR BUILD OSTAP : No valid source directory is found!' ${OSTAP_SOURCE}
    return 200 
fi

OSTAP_BUILD=${2:-$OSTAP_SOURCE/build}

if   [[ -d $OSTAP_BUILD && -w $OSTAP_BUILD ]]
then
    true 
elif [[ -w $OSTAP_SOURCE ]]
then 
    mkdir ${OSTAP_SOURCE}/build
    OSTAP_BUILD=${OSTAP_SOURCE}/build  
    echo  '----> BUILD OSTAP : Build directory is created' ${OSTAP_BUILD}
else
    OSTAP_BUILD=`mktemp -d -t ostap-$(date '+%Y-%b-%d')-OSTAP-BUILD-DIR-XXXXXX`
    echo  '----> BUILD OSTAP : Build directory is created' ${OSTAP_BUILD}
fi 

OSTAP_INSTALL=${3:-$OSTAP_BUILD/INSTALL}

cat <<EOF >rebuild_ostap.sh
#!/usr/bin/bash 

if [[ -d ${ROOTSYS} ]]
then 
    echo '----> (RE)BUILD OSTAP : ROOTSYS=' ${ROOTSYS} 
else 
    echo ' ERROR (RE)BUILD OSTAP : No ROOTSYS directory:' ${ROOTSYS}
    return 100
fi

if [[ -d ${OSTAP_SOURCE} ]]
then 
    echo '----> (RE)BUILD OSTAP : OSTAP_SOURCE='${OSTAP_SOURCE}
else
    echo ' ERROR (RE)BUILD OSTAP : No valid source directory is found!' ${OSTAP_SOURCE}
    return 200 
fi

if [[ -d ${OSTAP_BUILD} && -w ${OSTAP_BUILD} ]]
then
    echo '----> (RE)BUILD OSTAP : OSTAP_BUILD=:'${OSTAP_BUILD} 
else
    echo ' ERROR (RE)BUILD OSTAP : No valid build directory is found!' ${OSTAP_BUILD}
    return 100 
fi 

echo '----> (RE)BUILD OSTAP  OSTAP_INSTALL : ' ${OSTAP_INSTALL} 

if [[ -f ${OSTAP_BUILD}/build.ninja ]]
then
    ( echo '----> (RE)BUILD OSTAP [1/7] : CLEAN BUILD REMNANTS'       ; cd ${OSTAP_BUILD}  ; ninja clean )
fi

if [[ -d ${OSTAP_INSTALL} && -w ${OSTAP_INSTALL} ]]
then
    ( echo '----> (RE)BUILD OSTAP [2/7] : CLEAN INSTALL DIRECTORY'    ; cd ${OSTAP_INSTALL} ; rm -rfv .footprints .ostap.build .ostaprc .rootlogon.C cmake examples include lib scripts thisostap.sh packages )
fi

( echo '----> (RE)BUILD OSTAP [3/7] : REMOVE REMNANTS & GARBAGE'  ; cd ${OSTAP_BUILD} ; rm -rfv CM* CP* CT* *nin* scripts/ source/ ostap/ examples/ Testing/ Ma* .nin* Dart* cmake* instal* packages Tes* *.py~ *.C~ __* _CPack* \#* *~ .*~ .\#* )
( echo '----> (RE)BUILD OSTAP [4/7] : FIRST  PASS OF CMAKE+NINJA' ; cd ${OSTAP_BUILD} ; cmake --fresh ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date )
( echo '----> (RE)BUILD OSTAP [5/7] : SECOND PASS OF CMAKE+NINJA' ; cd ${OSTAP_BUILD} ; cmake         ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date )

if [[ -f ${OSTAP_INSTALL}/thisostap.sh &&
      -x ${OSTAP_INSTALL}/thisostap.sh ]]
then
    source ${OSTAP_INSTALL}/thisostap.sh
else
    echo ' ERROR (RE)BUILD OSTAP : No thisostap.sh is found ' ${OSTAP_INSTALL}/thisostap.sh 
    return 300 
fi

( echo '----> (RE)BUILD OSTAP [6/7] : THIRD  PASS OF CMAKE+NINJA'   ; cd ${OSTAP_BUILD} ; cmake ${OSTAP_SOURCE} -DCMAKE_INSTALL_PREFIX=${OSTAP_INSTALL} -G Ninja ; ninja ; ninja install | grep -v Up-to-date )
## ( echo '----> (RE_BUILD OSTAP [7/7] : LAST   PASS OF NINJA+CPACK'   ; cd ${OSTAP_BUILD} ; ninja ; ninja install | grep -v Up-to-date ; ninja package )

echo '----> (RE)BUILD OSTAP     : ROOTSYS         : ' ${ROOTSYS}
echo '----> (RE)BUILD OSTAP     : OSTAPDIR        : ' ${OSTAPDIR}
echo '----> (RE)BUILD OSTAP     : OSTAP_SOURCE    : ' ${OSTAP_SOURCE}
echo '----> (RE)BUILD OSTAP     : OSTAP_BUILD     : ' ${OSTAP_BUILD}
echo '----> (RE)BUILD OSTAP     : python          : ' `which python`
echo '----> (RE)BUILD OSTAP     : root.exe        : ' `which root.exe`
echo '----> (RE)BUILD OSTAP     : PYTHON VERSION  : ' `python --version`
echo '----> (RE)BUILD OSTAP     : OSTAP_INSTALL   : ' ${OSTAP_INSTALL}

if command -v tree &> /dev/null
then
    tree -d -L 3 --charset UTF-8 ${OSTAP_INSTALL}
fi 

EOF

if [[ -f ./rebuild_ostap.sh ]]
then
    mv ./rebuild_ostap.sh ${OSTAP_BUILD}/.rebuild-ostap
    chmod 755 ${OSTAP_BUILD}/.rebuild-ostap
else
    echo ' ERROR (RE)BUILD OSTAP : No .rebuild-ostap is found ' ${OSTAP_BUIILD}/.rebuild-ostap
    return 400 
fi

source ${OSTAP_BUILD}/.rebuild-ostap
result=$?

return $result
