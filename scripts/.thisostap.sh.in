#!/usr/bin/bash
# =====================================================================
# @file
# Helper script to  define the environment for ostap-@OSTAP_VERSION@ 
# =====================================================================

if [[ $PYTHONNOUSERSITE ]]
then
    echo 'thisostap.h: unset PYTHONNOUSERSITE' $PYTHONNOUSERSITE
    unset PYTHONNOUSERSITE
fi
    
function _path_prepend {
cat<<EOF | python - $1 $2 
import os,sys
path = sys.argv[1] 
item = sys.argv[2] if 2<len(sys.argv)  else ''
item = item.strip() 
path = os.environ.get ( path , '' )
path = path.split ( os.pathsep ) 
if item : path.insert ( 0 , item ) 
npath = []
for p in path : 
   if not os.path.exists ( p ) : continue 
   if not os.path.isdir  ( p ) : continue 
   pn = os.path.normpath ( p ) 
   if pn in npath              : continue 
   npath.append ( pn  )
path = os.pathsep.join ( npath )
print(path)
EOF
}

function _path_remove {
cat<<EOF | python - $1 $2 
import os,sys
#print sys.argv
path  = sys.argv[1] 
item  = sys.argv[2] if 2<len(sys.argv)  else ''
item  = item.strip() 
##print(path, item)
path  = os.environ.get ( path , '' )
path  = path.split ( os.pathsep ) 
npath = []
for p in path : 
   if os.path.exists ( item ) and os.path.samefile ( p , item ) : continue    
   if not os.path.exists ( p ) : continue 
   if not os.path.isdir  ( p ) : continue 
   pn = os.path.normpath ( p ) 
   if pn in npath              : continue 
   npath.append ( pn )
path = os.pathsep.join ( npath )
print(path)
EOF
}

## clean the path 
if [ -n "$OSTAP_DIR" ] ; then
   old_ostap_dir=${OSTAP_DIR}
   export PATH=$(            _path_remove PATH            $old_ostapdir/scripts ) 
   export PYTHONPATH=$(      _path_remove PYTHONPATH      $old_ostapdir                        ) 
   export PYTHONPATH=$(      _path_remove PYTHONPATH      $old_ostapdir@OSTAP_PYTHON_SITE_DIR@ ) 
   export LD_LIBRARY_PATH=$( _path_remove LD_LIBRARY_PATH $old_ostapdir/lib     ) 
   export MANPATH=$(         _path_remove MANPATH         $old_ostapdir/doc/man )
fi

# =============================================================================
## define OSTAP_DIR  as a directory where the script is located
# =============================================================================
OSTAP_DIR="${BASH_SOURCE[0]}"
# =============================================================================
if [ "x${OSTAP_DIR}" = "x" ]; then
    OSTAP_DIR=${(%):-%N} # for zsh
fi
# =============================================================================
while [ -h "${OSTAP_DIR}" ]; do # resolve ${OSTAP_DIR} until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "${OSTAP_DIR}" )" >/dev/null && pwd )"
  OSTAP_DIR="$(readlink "${OSTAP_DIR}")"
  [[ ${OSTAP_DIR} != /* ]] && OSTAP_DIR="$DIR/${OSTAP_DIR}" # if ${OSTAP_DIR} was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
OSTAP_DIR="$( cd -P "$( dirname "${OSTAP_DIR}" )" >/dev/null && pwd )" ; export OSTAP_DIR 

OSTAP_VERSION=@OSTAP_VERSION@                                       ; export OSTAP_VERSION

## update all   nesessary paths 
export PATH=$(            _path_prepend PATH            ${OSTAP_DIR}/scripts )
if [[ -d ${OSTAP_DIR}@OSTAP_PYTHON_SITE_DIR@  ]]
then
    export PYTHONPATH=$(  _path_prepend PYTHONPATH      ${OSTAP_DIR}@OSTAP_PYTHON_SITE_DIR@   )
else
    export PYTHONPATH=$(  _path_prepend PYTHONPATH      ${OSTAP_DIR}         )
fi 
export LD_LIBRARY_PATH=$( _path_prepend LD_LIBRARY_PATH ${OSTAP_DIR}/lib     )  
export MANPATH=$(         _path_prepend MANPATH         ${OSTAP_DIR}/doc/man )  

## CURPYVER=$( python -c 'import sys; print( sys.version_info[0])')
## if [ $CURPYVER == '2' ] && ( [ -v $PYTHONIOENCODING ] || [ -z $PYTHONIOENCODING ] ) ; then
##   PYTHONIOENCODING=UTF-8  ; export PYTHONIOENCODING 
## fi 
 
unset -f _path_prepend
unset -f _path_remove 

# =====================================================================
#                                                               The END 
# =====================================================================
 
